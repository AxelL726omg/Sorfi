<script>
let nombreUsuario = "";

const chatBox = document.getElementById("chat-box");
const input = document.getElementById("input-msg");
const sendBtn = document.getElementById("send-btn");

function pedirNombre() {
    nombreUsuario = prompt("Â¿CuÃ¡l es tu nombre?");
    if(!nombreUsuario || nombreUsuario.trim() === "") {
        nombreUsuario = "Usuario";
    }
    chatBox.innerHTML += `<div class="sorfi-msg">Â¡Hola ${nombreUsuario}! Soy Sorfi ðŸ’¬</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
}

// === MQTT ===
const broker = "wss://mqtt.flespi.io:443";
const token = "WE5ug92S0I6wxZXBrSgVn4zaYkcv0nEgnvTTBird4ATm5djaxGN90dt1XFpWogtx";
const topicIn = "chat/mensaje";
const topicOut = "chat/respuesta";

const client = mqtt.connect(broker, {
    username: token,
    password: "",
    reconnectPeriod: 3000,
    clientId: "webchat_" + Math.floor(Math.random() * 1000)
});

client.on("connect", () => {
    console.log("âœ… Conectado al broker MQTT");
    chatBox.innerHTML += `<div class="sorfi-msg">Sorfi estÃ¡ conectada y lista para chatear ðŸ’¬</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
    client.subscribe(topicOut);
});

client.on("error", err => {
    console.error("âŒ Error MQTT:", err);
});

client.on("message", (topic, message) => {
    const msg = message.toString();
    chatBox.innerHTML += `<div class="sorfi-msg">${msg}</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
});

// Para mostrar previsualizaciÃ³n mientras escribÃ­s
let previewDiv = null;

input.addEventListener("input", () => {
    if(!previewDiv) {
        previewDiv = document.createElement("div");
        previewDiv.className = "user-msg";
        chatBox.appendChild(previewDiv);
    }
    previewDiv.textContent = `[${nombreUsuario}]: ${input.value}`;
    chatBox.scrollTop = chatBox.scrollHeight;
});

input.addEventListener("blur", () => {
    // cuando dejas de escribir, se queda el mensaje final y limpia la previewDiv
    previewDiv = null;
});

function enviarMensaje() {
    const text = input.value.trim();
    if(!text) return;

    // El mensaje ya estaba en preview, solo aseguramos que se quede bien
    if(previewDiv) {
        previewDiv.textContent = `[${nombreUsuario}]: ${text}`;
        previewDiv = null;
    }

    // Publicar mensaje al broker
    if(text === "/finalizar") {
        client.publish(topicIn, "/finalizar");
        chatBox.innerHTML += `<div class="sorfi-msg">ConexiÃ³n cerrada. Hasta luego ðŸ˜¢</div>`;
        client.end(true);
        input.disabled = true;
        sendBtn.disabled = true;
    } else {
        client.publish(topicIn, `[${nombreUsuario}]:${text}`);
    }

    input.value = "";
}

// Eventos
sendBtn.addEventListener("click", enviarMensaje);
input.addEventListener("keypress", e => { if(e.key === "Enter") enviarMensaje(); });

// Pedir nombre al iniciar
pedirNombre();
</script>
