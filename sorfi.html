<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat con Sorfi ðŸ’¬</title>
<style>
    body {
        font-family: "Segoe UI", sans-serif;
        background-color: #f2f1f7;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
    }
    #chat-container {
        width: 400px;
        height: 500px;
        background: #fff;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
    }
    #chat-box {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    #input-msg {
        padding: 10px;
        flex: 0;
        border: 1px solid #ccc;
        border-radius: 5px;
        width: calc(100% - 70px);
    }
    #send-btn {
        padding: 10px;
        margin-left: 5px;
        background-color: #D63384;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .user-msg { color: #0078D7; font-weight: bold; margin-bottom: 5px; }
    .sorfi-msg { color: #D63384; margin-bottom: 5px; }
    .preview-msg { color: gray; font-style: italic; margin-bottom: 5px; }
</style>
</head>
<body>

<div id="chat-container">
    <div id="chat-box"></div>
    <div style="display: flex;">
        <input type="text" id="input-msg" placeholder="EscribÃ­ tu mensaje..." autocomplete="off"/>
        <button id="send-btn">Enviar</button>
    </div>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
let nombreUsuario = "";

const chatBox = document.getElementById("chat-box");
const input = document.getElementById("input-msg");
const sendBtn = document.getElementById("send-btn");
let previewDiv = null;

function pedirNombre() {
    nombreUsuario = prompt("Â¿CuÃ¡l es tu nombre?");
    if(!nombreUsuario || nombreUsuario.trim() === "") {
        nombreUsuario = "Usuario";
    }
    chatBox.innerHTML += `<div class="sorfi-msg">Â¡Hola ${nombreUsuario}! Soy Sorfi ðŸ’¬</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
}

// === MQTT ===
const broker = "wss://mqtt.flespi.io:443";
const token = "WE5ug92S0I6wxZXBrSgVn4zaYkcv0nEgnvTTBird4ATm5djaxGN90dt1XFpWogtx";
const topicIn = "chat/mensaje";
const topicOut = "chat/respuesta";

const client = mqtt.connect(broker, {
    username: token,
    password: "",
    reconnectPeriod: 3000,
    clientId: "webchat_" + Math.floor(Math.random() * 1000)
});

client.on("connect", () => {
    console.log("âœ… Conectado al broker MQTT");
    chatBox.innerHTML += `<div class="sorfi-msg">Sorfi estÃ¡ conectada y lista para chatear ðŸ’¬</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
    client.subscribe(topicOut);
});

client.on("error", err => {
    console.error("âŒ Error MQTT:", err);
});

client.on("message", (topic, message) => {
    const msg = message.toString();
    chatBox.innerHTML += `<div class="sorfi-msg">${msg}</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
});

// Mostrar previsualizaciÃ³n mientras se escribe
input.addEventListener("input", () => {
    if(!previewDiv) {
        previewDiv = document.createElement("div");
        previewDiv.className = "preview-msg";
        chatBox.appendChild(previewDiv);
    }
    previewDiv.textContent = `[${nombreUsuario}]: ${input.value}`;
    chatBox.scrollTop = chatBox.scrollHeight;
});

input.addEventListener("blur", () => {
    // cuando dejas de escribir, se queda el mensaje final y limpia previewDiv
    previewDiv = null;
});

function enviarMensaje() {
    const text = input.value.trim();
    if(!text) return;

    // El mensaje ya estaba en preview
    if(previewDiv) {
        previewDiv.textContent = `[${nombreUsuario}]: ${text}`;
        previewDiv.className = "user-msg";
        previewDiv = null;
    } else {
        chatBox.innerHTML += `<div class="user-msg">[${nombreUsuario}]: ${text}</div>`;
    }

    // Publicar mensaje al broker
    if(text === "/finalizar") {
        client.publish(topicIn, "/finalizar");
        chatBox.innerHTML += `<div class="sorfi-msg">ConexiÃ³n cerrada. Hasta luego ðŸ˜¢</div>`;
        client.end(true);
        input.disabled = true;
        sendBtn.disabled = true;
    } else {
        client.publish(topicIn, `[${nombreUsuario}]:${text}`);
    }

    input.value = "";
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Eventos
sendBtn.addEventListener("click", enviarMensaje);
input.addEventListener("keypress", e => { if(e.key === "Enter") enviarMensaje(); });

// Pedir nombre al iniciar
pedirNombre();
</script>
</body>
</html>
