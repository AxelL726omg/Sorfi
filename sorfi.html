<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat con Sorfi ðŸ’¬</title>
<style>
    body {
        font-family: "Segoe UI", sans-serif;
        background-color: #f2f1f7;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
    }
    #chat-container {
        width: 400px;
        height: 500px;
        background: #fff;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
    }
    #chat-box {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
    }
    #input-msg {
        padding: 10px;
        flex: 0;
        border: 1px solid #ccc;
        border-radius: 5px;
        width: calc(100% - 70px);
    }
    #send-btn {
        padding: 10px;
        margin-left: 5px;
        background-color: #D63384;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .user-msg { color: #0078D7; font-weight: bold; margin-bottom: 5px; }
    .sorfi-msg { color: #D63384; margin-bottom: 5px; }
</style>
</head>
<body>
<div id="chat-container">
    <div id="chat-box"></div>
    <div style="display: flex;">
        <input type="text" id="input-msg" placeholder="EscribÃ­ tu mensaje..." />
        <button id="send-btn">Enviar</button>
    </div>
</div>

<!-- mqtt.js -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const broker = "wss://mqtt.flespi.io:443";
const token = "WE5ug92S0I6wxZXBrSgVn4zaYkcv0nEgnvTTBird4ATm5djaxGN90dt1XFpWogtx";
const topicIn = "chat/mensaje";
const topicOut = "chat/respuesta";

const chatBox = document.getElementById("chat-box");
const input = document.getElementById("input-msg");
const sendBtn = document.getElementById("send-btn");

// Crear cliente MQTT
const client = mqtt.connect(broker, {
    username: token,
    password: "",
    reconnectPeriod: 3000,
    clientId: "webchat_" + Math.floor(Math.random() * 1000)
});

// Cuando se conecta
client.on("connect", () => {
    console.log("âœ… Conectado al broker MQTT");
    chatBox.innerHTML += `<div class="sorfi-msg">Sorfi estÃ¡ conectada y lista para chatear ðŸ’¬</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
    client.subscribe(topicOut);
});

// Manejo de errores
client.on("error", err => {
    console.error("âŒ Error MQTT:", err);
});

// Recibir mensajes de Sorfi
client.on("message", (topic, message) => {
    const msg = message.toString();
    chatBox.innerHTML += `<div class="sorfi-msg">${msg}</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
});

// Enviar mensaje
function enviarMensaje() {
    const text = input.value.trim();
    if(!text) return;

    // Mostrar mensaje del usuario
    chatBox.innerHTML += `<div class="user-msg">${text}</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;

    // Comando especial /finalizar
    if(text === "/finalizar") {
        chatBox.innerHTML += `<div class="sorfi-msg">ConexiÃ³n cerrada. Hasta luego ðŸ˜¢</div>`;
        client.end(true);
        input.disabled = true;
        sendBtn.disabled = true;
        return;
    }

    // Publicar mensaje al broker
    client.publish(topicIn, text);
    input.value = "";
}

// Eventos de botÃ³n y Enter
sendBtn.addEventListener("click", enviarMensaje);
input.addEventListener("keypress", e => { if(e.key === "Enter") enviarMensaje(); });
</script>
</body>
</html>
